<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Biblioteca de PDFs</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Google Font Bold -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&display=swap" rel="stylesheet">
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- PDF.js para preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
    pdfjs {
        display: block;
        margin: 0 auto;
    }
</style>

<style>
body { font-family: 'Inter', sans-serif; background:#f8f9fa; }
.card { border:none; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.08); transition: transform .2s; }
.card:hover { transform: translateY(-5px); }
.sticky-search { position:sticky; top:0; z-index:1020; background:#f8f9fa; padding:1rem 0; }
.search-input { border-radius:14px; padding:12px 16px; font-size:1rem; }

.carousel-inner img { height:180px; object-fit:cover; border-radius:12px; }

h1.header-animated {
  font-size:2.5rem;
  text-align:center;
  margin-bottom:2rem;
  background: linear-gradient(90deg, #4f46e5, #3b82f6, #06b6d4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: fadeIn 1s ease forwards;
  opacity:0;
}
@keyframes fadeIn {
  to { opacity:1; }
}

.btn-icon { display:flex; align-items:center; justify-content:center; padding:10px; border-radius:12px; font-size:1rem; gap:6px; }

/* Modal styles */
.modal-content { border-radius:16px; }
.pdf-preview-container { height:500px; overflow-y:auto; border:1px solid #dee2e6; border-radius:8px; }
.pdf-controls { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:15px; }

/* Loading spinner */
.spinner-border { width:1.5rem; height:1.5rem; }

/* Notification */
.toast-container { z-index:9999; }
</style>
</head>
<body>

<div class="container py-4">

<!-- Cabeçalho animado -->
<h1 class="header-animated">Biblioteca de PDFs</h1>

<!-- Pesquisa fixa -->
<div class="sticky-search mb-4">
  <input type="text" id="search" class="form-control search-input" placeholder=" Pesquisar PDF...">
</div>

<!-- Lista de PDFs -->
<div class="row" id="lista"></div>

</div>

<!-- Modal para Preview do PDF -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfPreviewTitle">Pré-visualização do PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="pdf-preview-container" id="pdfPreviewContainer">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando PDF...</span>
            </div>
            <p class="mt-2">Carregando pré-visualização...</p>
          </div>
        </div>
        <div class="pdf-controls">
          <button class="btn btn-outline-primary" id="prevPage">
            <i data-lucide="chevron-left"></i> Anterior
          </button>
          <span class="mx-3">Página: <span id="pageNum">1</span> / <span id="pageCount">1</span></span>
          <button class="btn btn-outline-primary" id="nextPage">
            Próximo <i data-lucide="chevron-right"></i>
          </button>
          <div class="ms-3">
            <label for="zoomLevel" class="form-label me-2">Zoom:</label>
            <select id="zoomLevel" class="form-select form-select-sm d-inline-block" style="width:100px">
              <option value="1">100%</option>
              <option value="1.25">125%</option>
              <option value="1.5">150%</option>
              <option value="2">200%</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <a href="#" id="downloadFromPreview" class="btn btn-primary" target="_blank">
          <i data-lucide="download"></i> Baixar PDF
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Notificação Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="notificationToast" class="toast" role="alert">
    <div class="toast-header">
      <strong class="me-auto">Biblioteca de PDFs</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Inicializar ícones do Lucide
lucide.createIcons();

// Sistema de Rastreamento
class TrackingSystem {
  constructor() {
    this.apiUrl = 'https://api.ipify.org?format=json';
    this.trackingEndpoint = 'https://script.google.com/macros/s/AKfycbxEtyu4F4kRFvdWq7Y04R3jj9SOEqMAbh3l_K9lSMjAfE4Lh7rOaB2E3PcrLVcYxQrX/exec'; // Substitua com seu endpoint
    this.visitorId = this.getVisitorId();
    this.trackVisit();
  }

  getVisitorId() {
    let visitorId = localStorage.getItem('pdf_visitor_id');
    if (!visitorId) {
      visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('pdf_visitor_id', visitorId);
    }
    return visitorId;
  }

  async getIpAddress() {
    try {
      const response = await fetch(this.apiUrl);
      const data = await response.json();
      return data.ip;
    } catch (error) {
      return 'unknown';
    }
  }

  async trackVisit() {
    const ip = await this.getIpAddress();
    const visitData = {
      type: 'visit',
      visitorId: this.visitorId,
      ip: ip,
      userAgent: navigator.userAgent,
      url: window.location.href,
      timestamp: new Date().toISOString(),
      referrer: document.referrer || 'direct'
    };

    this.sendTrackingData(visitData);
  }

  trackDownload(pdfId, pdfName) {
    const downloadData = {
      type: 'download',
      visitorId: this.visitorId,
      pdfId: pdfId,
      pdfName: pdfName,
      timestamp: new Date().toISOString()
    };

    this.sendTrackingData(downloadData);
    this.showNotification('Download registrado com sucesso!');
  }

  trackPreview(pdfId, pdfName) {
    const previewData = {
      type: 'preview',
      visitorId: this.visitorId,
      pdfId: pdfId,
      pdfName: pdfName,
      timestamp: new Date().toISOString()
    };

    this.sendTrackingData(previewData);
  }

  sendTrackingData(data) {
    // Usando Google Apps Script para armazenamento (substitua com seu endpoint)
    fetch(this.trackingEndpoint, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(data),
      headers: {
        'Content-Type': 'application/json'
      }
    }).catch(error => {
      console.log('Dados de rastreamento:', data);
    });
  }
}

// Sistema de Preview do PDF
class PDFPreviewSystem {
  constructor() {
    this.pdfDoc = null;
    this.currentPage = 1;
    this.scale = 1.0;
    this.canvas = null;
    this.ctx = null;
  }

  async loadPDF(url) {
    try {
      // Configurar PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      
      const loadingTask = pdfjsLib.getDocument(url);
      this.pdfDoc = await loadingTask.promise;
      
      document.getElementById('pageCount').textContent = this.pdfDoc.numPages;
      this.renderPage(this.currentPage);
    } catch (error) {
      this.showError('Erro ao carregar o PDF. Tente novamente.');
    }
  }

  async renderPage(num) {
    if (!this.pdfDoc) return;
    
    this.currentPage = num;
    document.getElementById('pageNum').textContent = this.currentPage;
    
    try {
      const page = await this.pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: this.scale });
      
      if (!this.canvas) {
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        document.getElementById('pdfPreviewContainer').innerHTML = '';
        document.getElementById('pdfPreviewContainer').appendChild(this.canvas);
      }
      
      this.canvas.height = viewport.height;
      this.canvas.width = viewport.width;
      
      const renderContext = {
        canvasContext: this.ctx,
        viewport: viewport
      };
      
      await page.render(renderContext).promise;
    } catch (error) {
      this.showError('Erro ao renderizar página.');
    }
  }

  nextPage() {
    if (this.pdfDoc && this.currentPage < this.pdfDoc.numPages) {
      this.renderPage(this.currentPage + 1);
    }
  }

  prevPage() {
    if (this.currentPage > 1) {
      this.renderPage(this.currentPage - 1);
    }
  }

  changeZoom(newScale) {
    this.scale = parseFloat(newScale);
    if (this.pdfDoc) {
      this.renderPage(this.currentPage);
    }
  }

  showError(message) {
    document.getElementById('pdfPreviewContainer').innerHTML = `
      <div class="alert alert-danger m-3" role="alert">
        <i data-lucide="alert-circle"></i> ${message}
      </div>
    `;
    lucide.createIcons();
  }

  reset() {
    this.pdfDoc = null;
    this.currentPage = 1;
    this.scale = 1.0;
    this.canvas = null;
    this.ctx = null;
  }
}

// Inicializar sistemas
const tracker = new TrackingSystem();
const pdfPreview = new PDFPreviewSystem();

// Variáveis globais para controle do PDF atual
let currentPreviewPdf = { id: null, name: null, url: null };

// Função para exibir notificação
function showNotification(message, type = 'info') {
  const toastEl = document.getElementById('notificationToast');
  const toastBody = toastEl.querySelector('.toast-body');
  
  toastBody.textContent = message;
  
  // Definir cor baseada no tipo
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}

// Carregar e exibir PDFs
async function loadPDFs() {
  try {
    const response = await fetch('pdfs.json');
    const pdfs = await response.json();
    
    const container = document.getElementById('lista');
    const searchInput = document.getElementById('search');
    
    function renderPDFs(filter = '') {
      container.innerHTML = '';
      const filtered = pdfs.filter(pdf => 
        pdf.nome.toLowerCase().includes(filter.toLowerCase()) ||
        pdf.categoria.toLowerCase().includes(filter.toLowerCase())
      );
      
      filtered.forEach(pdf => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-4';
        
        col.innerHTML = `
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${pdf.nome}</h5>
              <p class="card-text text-muted">${pdf.descricao}</p>
              <div class="mb-2">
                <span class="badge bg-primary">${pdf.categoria}</span>
                ${pdf.tags ? pdf.tags.split(',').map(tag => 
                  `<span class="badge bg-secondary ms-1">${tag.trim()}</span>`
                ).join('') : ''}
              </div>
              <div class="mt-auto">
                <small class="text-muted">Adicionado em: ${pdf.data}</small>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <div class="d-flex justify-content-between">
                <button class="btn btn-primary btn-icon preview-btn" 
                        data-id="${pdf.id}" 
                        data-name="${pdf.nome}" 
                        data-url="${pdf.url}">
                  <i data-lucide="eye"></i> Pré-visualizar
                </button>
                <a href="${pdf.url}" 
                   class="btn btn-success btn-icon download-btn" 
                   data-id="${pdf.id}" 
                   data-name="${pdf.nome}" 
                   target="_blank">
                  <i data-lucide="download"></i> Baixar
                </a>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(col);
      });
      
      // Atualizar ícones
      lucide.createIcons();
      
      // Adicionar event listeners para os botões
      document.querySelectorAll('.preview-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const pdfId = this.getAttribute('data-id');
          const pdfName = this.getAttribute('data-name');
          const pdfUrl = this.getAttribute('data-url');
          
          // Rastrear preview
          tracker.trackPreview(pdfId, pdfName);
          
          // Abrir modal de preview
          openPDFPreview(pdfId, pdfName, pdfUrl);
        });
      });
      
      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const pdfId = this.getAttribute('data-id');
          const pdfName = this.getAttribute('data-name');
          
          // Rastrear download
          tracker.trackDownload(pdfId, pdfName);
        });
      });
    }
    
    // Renderizar inicialmente
    renderPDFs();
    
    // Filtro de pesquisa
    searchInput.addEventListener('input', function() {
      renderPDFs(this.value);
    });
    
  } catch (error) {
    console.error('Erro ao carregar PDFs:', error);
    showNotification('Erro ao carregar a lista de PDFs', 'error');
  }
}

// Função para abrir preview do PDF
function openPDFPreview(pdfId, pdfName, pdfUrl) {
  currentPreviewPdf = { id: pdfId, name: pdfName, url: pdfUrl };
  
  // Atualizar título do modal
  document.getElementById('pdfPreviewTitle').textContent = `Pré-visualização: ${pdfName}`;
  
  // Atualizar link de download
  document.getElementById('downloadFromPreview').href = pdfUrl;
  document.getElementById('downloadFromPreview').setAttribute('data-id', pdfId);
  document.getElementById('downloadFromPreview').setAttribute('data-name', pdfName);
  
  // Resetar preview system
  pdfPreview.reset();
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
  modal.show();
  
  // Quando o modal for mostrado, carregar o PDF
  document.getElementById('pdfPreviewModal').addEventListener('shown.bs.modal', async function() {
    // Mostrar loading
    document.getElementById('pdfPreviewContainer').innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando PDF...</span>
        </div>
        <p class="mt-2">Carregando pré-visualização...</p>
      </div>
    `;
    
    // Carregar PDF
    await pdfPreview.loadPDF(pdfUrl);
  });
}

// Event listeners para controles do PDF
document.getElementById('nextPage').addEventListener('click', () => pdfPreview.nextPage());
document.getElementById('prevPage').addEventListener('click', () => pdfPreview.prevPage());
document.getElementById('zoomLevel').addEventListener('change', (e) => pdfPreview.changeZoom(e.target.value));

// Event listener para download do preview
document.getElementById('downloadFromPreview').addEventListener('click', function() {
  const pdfId = this.getAttribute('data-id');
  const pdfName = this.getAttribute('data-name');
  tracker.trackDownload(pdfId, pdfName);
  showNotification(`Baixando: ${pdfName}`);
});

// Carregar PDFs quando a página carregar
document.addEventListener('DOMContentLoaded', loadPDFs);

// Mostrar mensagem de boas-vindas
window.addEventListener('load', () => {
  showNotification('Bem-vindo à Biblioteca de PDFs!');
});
</script>
</body>
  </html>
